/**
 * @file main.c
 * @generated by $PREESM_PRINTER
 * @date $PREESM_DATE
 */

#[[#]]#include "socketcom.h"
#[[#]]#include <pthread.h>

#[[#]]#include <execinfo.h>
#[[#]]#include <signal.h>

#[[#]]#define PREESM_COM_PORT 25400
#[[#]]#define _PREESM_NBTHREADS_ $PREESM_NBTHREADS

ProcessingElement registry[_PREESM_NBTHREADS_];

$PREESM_THREAD_FUNCTIONS_DECLS

void *(*coreThreadComputations[_PREESM_NBTHREADS_])(void *) = {
  $PREESM_THREAD_FUNCTIONS
};


void handler(int sig) {
  void *array[30];
  size_t size;
  size = backtrace(array, 30);
  fprintf(stderr, "Error: signal %d:\n", sig);
  backtrace_symbols_fd(array, size, STDERR_FILENO);
  exit(1);
}

// kept for compatibility
pthread_barrier_t iter_barrier;
int stopThreads;

void actualThreadComputations(int processingElementID) {
  int socketFileDescriptors[_PREESM_NBTHREADS_ + 1];
  socketFileDescriptors[_PREESM_NBTHREADS_] = processingElementID;

  preesm_open(socketFileDescriptors, processingElementID, _PREESM_NBTHREADS_, registry);
#[[#]]#ifdef _PREESM_TCP_DEBUG_
  printf("[TCP-DEBUG] %d READY\n", processingElementID);
#[[#]]#endif
  coreThreadComputations[processingElementID](socketFileDescriptors);
#[[#]]#ifdef _PREESM_TCP_DEBUG_
  printf("[TCP-DEBUG] %d DONE\n", processingElementID);
#[[#]]#endif
  preesm_close(socketFileDescriptors, processingElementID, _PREESM_NBTHREADS_);
}

void * threadComputations (void *arg) {
  int processingElementID = *((int*) arg);
  actualThreadComputations(processingElementID);
  return NULL;
}

int main(int argc, char** argv) {
//  stopThreads = 0;
  signal(SIGSEGV, handler);
  signal(SIGPIPE, handler);

  // TODO overide pes array with values from config file/arguments
  for (int i = 0; i < _PREESM_NBTHREADS_; i++) {
    registry[i].id = i;
    registry[i].host = "127.0.0.1";
    registry[i].port=(PREESM_COM_PORT+i);
  }
  if (argc == 2) {
    // read ID from arguments
    int peId = atoi(argv[1]);
#[[#]]#ifdef _PREESM_TCP_DEBUG_
  printf("[TCP-DEBUG] Runnin %d only\n", peId);
#[[#]]#endif

//    pthread_barrier_init(&iter_barrier, NULL, 1);
    actualThreadComputations(peId);
  } else {
//	pthread_barrier_init(&iter_barrier, NULL, _PREESM_NBTHREADS_);
    // launch all IDs in separate threads
    pthread_t threads[_PREESM_NBTHREADS_];
    int threadArguments[_PREESM_NBTHREADS_];
    for (int i = 0; i < _PREESM_NBTHREADS_; i++) {
      threadArguments[i] = i;
      pthread_create(&threads[i], NULL, threadComputations, &(threadArguments[i]));
    }
    for (int i = 0; i < _PREESM_NBTHREADS_; i++) {
      pthread_join(threads[i], NULL);
    }
  }
  return 0;
}



